<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>노원구 공릉동 카페 지도</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet-freedraw@2.3.0/dist/leaflet-freedraw.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-freedraw@2.3.0/dist/leaflet-freedraw.css" />

    <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .main-container {
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            max-height: 700px;
            display: flex;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            background-color: #fff;
            flex-direction: column;
        }
        
        .map-section {
            display: flex;
            flex-grow: 1;
        }

        .controls {
            padding: 10px 20px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        #toggle-draw {
            background-color: #3498db;
            color: #fff;
        }

        #toggle-draw.active {
            background-color: #2980b9;
        }

        #take-screenshot {
            background-color: #2ecc71;
            color: #fff;
        }

        #take-screenshot:hover {
            transform: translateY(-2px);
        }

        #map-container {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }

        #map {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }

        .sidebar {
            width: 280px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            background-color: #fff;
        }

        .map-title {
            font-size: 24px;
            font-weight: 700;
            line-height: 1.2;
            color: #333;
            margin-bottom: 20px;
        }

        .leaflet-popup-content b { font-size: 16px; }
        .leaflet-popup-content small { color:#555; }
        
        .category-select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
            font-size: 14px;
            background: #fff;
            margin-bottom: 20px;
        }

        .legend {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            background-color: #f8f9fa;
        }

        .legend h4 {
            margin: 0 0 10px;
            font-size: 16px;
            color: #555;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .legend-icon-box {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .legend-icon-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        @media (prefers-color-scheme: dark) {
            body { background-color: #2c2f33; }
            .main-container, .sidebar, .legend, .category-select {
                background-color: #36393f;
                color: #e8e8e8;
            }
            .map-title, .legend h4 { color: #e8e8e8; }
            .legend-item { color: #e8e8e8; }
            .category-select {
                border-color: #555;
                background: #40444b;
                color: #e8e8e8;
            }
            .controls { background-color: #40444b; border-bottom: 1px solid #555; }
            .action-button { color: #e8e8e8; }
            #toggle-draw { background-color: #5b8db5; }
            #toggle-draw.active { background-color: #4a779b; }
            #take-screenshot { background-color: #57b37f; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="controls">
            <button id="toggle-draw" class="action-button">
                그리기
            </button>
            <button id="take-screenshot" class="action-button">
                스크린샷
            </button>
        </div>
        <div class="map-section">
            <div id="map-container">
                <div id="map"></div>
            </div>
            <div class="sidebar">
                <div class="map-title">노원구 공릉동 카페 지도</div>
                
                <select id="categoryFilter" class="category-select">
                    <option value="all">전체</option>
                    <option value="베이커리">베이커리</option>
                    <option value="디저트">디저트</option>
                    <option value="로스터리">로스터리</option>
                    <option value="대형">대형</option>
                    <option value="기타">기타</option>
                </select>

                <div class="legend">
                    <h4>핀 종류</h4>
                    <div class="legend-item">
                        <div class="legend-icon-box"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png" alt="베이커리 아이콘"></div>
                        <span>베이커리</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon-box"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png" alt="디저트 아이콘"></div>
                        <span>디저트</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon-box"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png" alt="로스터리 아이콘"></div>
                        <span>로스터리</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon-box"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png" alt="대형 카페 아이콘"></div>
                        <span>대형 카페</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon-box"><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png" alt="기타 아이콘"></div>
                        <span>기타 카페</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const DATA = {
            "stores": [
                {"name":"기차가 있는 풍경","address":"서울 노원구 화랑로 446","lat":37.620078,"lng":127.086435, "category": "기타"},
                {"name":"블루샥 공릉점","address":"서울 노원구 공릉로 219","lat":37.631248,"lng":127.074712, "category": "기타"},
                {"name":"던모스 공릉","address":"서울 노원구 동일로190길 63-14","lat":37.625892,"lng":127.076846, "category": "기타"},
                {"name":"파운드 그레도 공릉","address":"서울 노원구 공릉로 231","lat":37.632007,"lng":127.075482, "category": "대형"},
                {"name":"리프노즈 드 아쉬지 공릉","address":"서울 노원구 공릉로 136-1","lat":37.627341,"lng":127.071880, "category": "디저트"},
                {"name":"스타벅스 태릉입구역DT점","address":"서울 노원구 동일로 1060","lat":37.618037,"lng":127.073400, "category": "기타"},
                {"name":"컴포즈커피 공릉경춘선숲길점","address":"서울 노원구 공릉로 219-1","lat":37.631350,"lng":127.074850, "category": "기타"},
                {"name":"무드쉐어","address":"서울 노원구 공릉로 119-23","lat":37.626880,"lng":127.071060, "category": "디저트"},
                {"name":"블루마일스","address":"서울 노원구 동일로190길 65","lat":37.625902,"lng":127.076882, "category": "로스터리"},
                {"name":"마이브라더스","address":"서울 노원구 공릉로 211","lat":37.630656,"lng":127.074312, "category": "베이커리"},
                {"name":"공트럴파크 카페","address":"서울 노원구 공릉동 675","lat":37.6262,"lng":127.0768, "category": "기타"},
                {"name":"호이폴로이커피로스터스","address":"서울 노원구 동일로192길 44","lat":37.626359,"lng":127.077227, "category": "로스터리"},
                {"name":"트위그 페스츄리","address":"서울 노원구 동일로190길 63-14","lat":37.625950,"lng":127.076900, "category": "베이커리"},
                {"name":"플랫커피 공릉","address":"서울 노원구 동일로 192길 63-15","lat":37.625573,"lng":127.076882, "category": "기타"},
                {"name":"금성다방 공릉","address":"서울 노원구 공릉로39길 10","lat":37.618608,"lng":127.076936, "category": "기타"},
                {"name":"카페오나시","address":"서울 노원구 공릉로39길 17","lat":37.618620,"lng":127.077050, "category": "베이커리"},
                {"name":"브루클린","address":"서울 노원구 동일로 191길 22","lat":37.625620,"lng":127.077300, "category": "기타"},
                {"name":"카페아몽","address":"서울 노원구 공릉로 141-1","lat":37.627680,"lng":127.072210, "category": "기타"},
                {"name":"메이","address":"서울 노원구 동일로 191길 21-1","lat":37.625600,"lng":127.077200, "category": "디저트"},
                {"name":"아키라 커피","address":"서울 노원구 공릉로 189길 56","lat":37.628000,"lng":127.081800, "category": "로스터리"},
                {"name":"우드무드커피","address":"서울 노원구 공릉로 209-1","lat":37.631020,"lng":127.074150, "category": "로스터리"},
                {"name":"코피티암 공릉점","address":"서울 노원구 공릉로 215","lat":37.631100,"lng":127.074400, "category": "기타"},
                {"name":"공차 공릉역점","address":"서울 노원구 공릉로 209","lat":37.631000,"lng":127.074080, "category": "기타"},
                {"name":"더치앤빈 서울과학기술대점","address":"서울 노원구 공릉로 232","lat":37.632200,"lng":127.075480, "category": "기타"},
                {"name":"커피베이 공릉역점","address":"서울 노원구 공릉로 209","lat":37.631000,"lng":127.074080, "category": "기타"},
                {"name":"디저트1291","address":"서울 노원구 공릉로 225-1","lat":37.631600,"lng":127.075100, "category": "디저트"},
                {"name":"카페포롱","address":"서울 노원구 동일로180길 48","lat":37.626300,"lng":127.079550, "category": "디저트"},
                {"name":"키로","address":"서울 노원구 동일로180길 56","lat":37.626600,"lng":127.080000, "category": "로스터리"},
                {"name":"카린지","address":"서울 노원구 동일로180길 38","lat":37.625900,"lng":127.079100, "category": "디저트"},
                {"name":"그대가꽃","address":"서울 노원구 공릉로 41길 19","lat":37.622800,"lng":127.075200, "category": "디저트"},
                {"name":"공트럴파크베이커리","address":"서울 노원구 공릉로 234","lat":37.632250,"lng":127.075600, "category": "베이커리"}
            ]
        };
        
        const icons = {
            "베이커리": new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            "디저트": new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            "로스터리": new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            "대형": new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            "기타": new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            })
        };

        const map = L.map('map', {
            center: [37.6262, 127.0768],
            zoom: 15,
            scrollWheelZoom: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markers = L.markerClusterGroup({ showCoverageOnHover: false, spiderfyOnMaxZoom: true });
        
        function addMarkers(category) {
            markers.clearLayers(); 
            const filteredStores = DATA.stores.filter(store => {
                return category === 'all' || store.category === category;
            });

            const bounds = [];
            filteredStores.forEach(store => {
                if (!Number.isFinite(store.lat) || !Number.isFinite(store.lng)) return;
                const popupHtml = `<div><b>${store.name}</b><br/><small>${store.address || ''}</small></div>`;
                const icon = icons[store.category] || icons['기타'];
                const m = L.marker([store.lat, store.lng], { icon: icon }).bindPopup(popupHtml);
                const tooltipText = `${store.name}<br/>${store.address}`;
                m.bindTooltip(tooltipText, { permanent: false, direction: 'top' });
                markers.addLayer(m);
                bounds.push([store.lat, store.lng]);
            });
            
            map.addLayer(markers);
            if (bounds.length) map.fitBounds(bounds, { padding: [24, 24] });
        }

        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            console.log('카테고리 필터 변경됨:', e.target.value);
            const selectedCategory = e.target.value;
            addMarkers(selectedCategory);
        });

        addMarkers('all');

        // 펜 그리기 기능
        const freeDraw = new L.FreeDraw({
            mode: L.FreeDraw.MODES.VIEW,
            strokeWidth: 4,
            strokeColor: '#e74c3c'
        });
        map.addLayer(freeDraw);

        // 이벤트 리스너를 사용하여 버튼 클릭 시 기능 실행
        const toggleDrawButton = document.getElementById('toggle-draw');
        const takeScreenshotButton = document.getElementById('take-screenshot');
        
        toggleDrawButton.addEventListener('click', () => {
            console.log('그리기 버튼 클릭됨');
            if (freeDraw.mode === L.FreeDraw.MODES.CREATE) {
                freeDraw.setMode(L.FreeDraw.MODES.VIEW);
                toggleDrawButton.classList.remove('active');
                toggleDrawButton.textContent = '그리기';
            } else {
                freeDraw.setMode(L.FreeDraw.MODES.CREATE);
                toggleDrawButton.classList.add('active');
                toggleDrawButton.textContent = '그리기 (활성화)';
            }
        });

        takeScreenshotButton.addEventListener('click', () => {
            console.log('스크린샷 버튼 클릭됨');
            // 스크린샷을 찍기 전에 펜 모드를 자동으로 끕니다.
            freeDraw.setMode(L.FreeDraw.MODES.VIEW);
            toggleDrawButton.classList.remove('active');
            toggleDrawButton.textContent = '그리기';

            const mapContainer = document.getElementById('map-container');

            domtoimage.toPng(mapContainer)
                .then(function (dataUrl) {
                    const link = document.createElement('a');
                    link.download = '공릉동_카페_지도.png';
                    link.href = dataUrl;
                    link.click();
                })
                .catch(function (error) {
                    console.error('oops, something went wrong!', error);
                    alert('스크린샷을 저장하는 데 실패했습니다.');
                });
        });
    });
    </script>
</body>
</html>
